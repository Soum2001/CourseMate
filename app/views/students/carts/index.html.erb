<div class="container my-5">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Shopping Cart</h2>
    <%= link_to "Browse Courses",
                students_courses_path,
                class: "btn btn-outline-primary rounded-pill px-4" %>
  </div>

  <% if @courses.any? %>

    <div class="row">

      <!-- LEFT SIDE : TABLE -->
      <div class="col-md-8">

        <table class="table align-middle shadow-sm" style="border-radius: 12px; overflow: hidden;">
          <tbody>

            <% @courses.each do |course| %>
              <tr class="bg-white">

                <!-- Thumbnail -->
                <td style="width: 180px;">
                  <div class="ratio ratio-16x9 rounded overflow-hidden">
                    <iframe 
                      src="https://www.youtube.com/embed/EzKImzjwGyM"
                      allowfullscreen>
                    </iframe>
                  </div>
                </td>

                <!-- Title + description -->
                <td style="width: 55%;">
                  <h5 class="fw-semibold mb-1"><%= course.title %></h5>
                  <p class="text-muted small mb-1">
                    <%= truncate(course.description, length: 80) %>
                  </p>
        
                  <%= link_to "Remove",
                    students_cart_item_path(@cart.cart_items.find_by(course_id: course.id).id),
                    data: { turbo_method: :delete},
                    class: "text-danger small fw-semibold" %>
                </td>

                <!-- Price -->
                <td class="text-end">
                  <p class="fw-bold fs-5 mb-0 text-dark">
                    ₹ <%= course.amount %>
                  </p>
                </td>

              </tr>
            <% end %>

          </tbody>
        </table>

      </div>

      <!-- RIGHT SIDE : ORDER SUMMARY -->
      <div class="col-md-4">

        <div class="card shadow-lg border-0 rounded-4 p-4 sticky-top" style="top: 80px;">

          <h4 class="fw-bold mb-4">Order Summary</h4>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Subtotal</span>
            <span class="fw-semibold">₹<%= @courses.sum(&:amount) %></span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Tax (10%)</span>
            <span class="fw-semibold">₹<%= (@courses.sum(&:amount) * 0.10).round %></span>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <span class="text-muted">Discount</span>
            <span class="fw-semibold text-success">₹0</span>
          </div>

          <hr>

          <div class="d-flex justify-content-between mb-4">
            <h5 class="fw-bold">Total</h5>
            <h5 class="fw-bold text-primary">
              ₹<%= (@courses.sum(&:amount) * 1.10).round %>
            </h5>
          </div>

          <!-- CHECKOUT BUTTON -->
          <div class="d-grid mt-3">
            <button id="checkout-button" class="btn btn-primary btn-lg rounded-pill">
              Proceed to Checkout
            </button>
          </div>

          <!-- Stripe card element -->
          <div id="card-element" class="mt-3"></div>
          <p id="card-errors" class="text-danger small mt-2"></p>

        </div>

      </div>

    </div>

  <% else %>

    <!-- EMPTY CART -->
    <div class="text-center py-5">
      <h4 class="fw-semibold">Your cart is empty</h4>
      <p class="text-muted mb-3">Add some courses to continue.</p>

      <%= link_to "Browse Courses",
                  students_courses_path,
                  class: "btn btn-primary rounded-pill px-4" %>
    </div>

  <% end %>
</div>


<!-- Stripe Script -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("<%= Rails.configuration.stripe[:publishable_key] %>");

  document.getElementById("checkout-button").addEventListener("click", async () => {

    const response = await fetch("/students/checkouts", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": "<%= form_authenticity_token %>"
      },
      body: JSON.stringify({
        course_ids: <%= @courses.map(&:id) %>
      })
    });

    const session = await response.json();

    // THIS opens Stripe’s pre-built checkout page
    stripe.redirectToCheckout({ sessionId: session.id });
  });
</script>

